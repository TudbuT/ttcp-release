package de.tudbut.mod.client.ttcp.mods.combat;

import net.minecraft.client.gui.GuiMainMenu;
import net.minecraft.client.gui.GuiMultiplayer;
import net.minecraft.init.Items;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketConfirmTeleport;
import net.minecraft.network.play.client.CPacketPlayerTryUseItem;
import net.minecraft.network.play.client.CPacketUseEntity;
import net.minecraft.server.integrated.IntegratedServer;
import net.minecraft.util.EnumHand;
import net.minecraft.world.WorldSettings;
import net.minecraftforge.fml.client.FMLClientHandler;
import de.tudbut.mod.client.ttcp.gui.lib.component.Button;
import de.tudbut.mod.client.ttcp.utils.BlockUtils;
import de.tudbut.mod.client.ttcp.utils.InventoryUtils;
import de.tudbut.mod.client.ttcp.utils.Module;
import de.tudbut.mod.client.ttcp.utils.Setting;
import de.tudbut.mod.client.ttcp.utils.category.Combat;

import java.util.ArrayList;

@Combat
public class PortalInvulnerability extends Module {
    
    ArrayList<Packet<?>> toSend = new ArrayList<>();

    @Override
    public void updateBinds() {
        customKeyBinds.setIfNull("pearl", new KeyBind(null, this + "::pearl", true));
        subComponents.add(new Button("Pearl now", x -> pearl()));
        subComponents.add(Setting.createKey("Pearl", customKeyBinds.get("pearl")));
    }
    
    public void pearl() {
        onDisable();
        if(!enabled) toggle();
        Integer item = InventoryUtils.getSlotWithItem(player.inventoryContainer, Items.ENDER_PEARL, new int[0], 1, Integer.MAX_VALUE);
        if(item == null) {
            toggle();
            return;
        }
        int slot = InventoryUtils.getCurrentSlot();
        select: {
            if(item >= 9 * 4) {
                InventoryUtils.setCurrentSlot(item - 9 * 4);
                break select;
            }
            else {
                InventoryUtils.inventorySwap(item, 9 * 4 + 7, 0, 0, 0);
                InventoryUtils.setCurrentSlot(7);
            }
        }
        BlockUtils.lookAt(player.getPositionVector());
        player.connection.sendPacket(new CPacketPlayerTryUseItem(EnumHand.MAIN_HAND));
        InventoryUtils.setCurrentSlot(slot);
    }

    @Override
    public boolean onPacket(Packet<?> packet) {
        if (packet instanceof CPacketConfirmTeleport) {
            toSend.add(packet);
            return true;
        }
        return false;
    }
    
    @Override
    public void onDisable() {
        for (Packet<?> packet : toSend) {
            player.connection.sendPacket(packet);
        }
        toSend.clear();
    }
}
